<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask 署名デモ</title>
</head>
<body>
    <h1>MetaMask 接続 & 署名デモ</h1>
    <button id="connectWallet">MetaMaskを開いて接続</button>
    <p id="accountAddress"></p>
    <p id="signature"></p>

    <script>
        const connectWalletButton = document.getElementById('connectWallet');
        const accountAddressElement = document.getElementById('accountAddress');
        const signatureElement = document.getElementById('signature');

        connectWalletButton.addEventListener('click', async () => {
            // MetaMaskをディープリンクで開く
            const dappUrl = encodeURIComponent(window.location.href); // 現在のページのURLをdApp URLとして指定
            const metamaskDeepLink = `https://metamask.app.link/dapp/${dappUrl}`;
            window.location.href = metamaskDeepLink;
        });

        // ページがロードされたとき、MetaMaskが注入しているかチェックして接続
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const provider = new ethers.providers.Web3Provider(window.ethereum);

                try {
                    // ウォレット接続リクエスト
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    const account = accounts[0];
                    accountAddressElement.textContent = `接続されたアドレス: ${account}`;

                    // 署名リクエスト
                    const message = "これは署名するメッセージです。";
                    const signature = await provider.getSigner().signMessage(message);
                    signatureElement.textContent = `署名: ${signature}`;

                } catch (err) {
                    console.error('接続エラー:', err);
                    accountAddressElement.textContent = 'ウォレット接続に失敗しました。';
                    signatureElement.textContent = '';
                }
            } else {
                accountAddressElement.textContent = 'MetaMaskがインストールされていません。';
                signatureElement.textContent = '';
            }
        });
    </script>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
</body>
</html>
