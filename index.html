<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ウォレット接続と署名</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</head>
<body>
  <h1>ウォレット接続と署名</h1>
  <button id="connect">ウォレット接続＆署名</button>
  <p id="status"></p>

  <script>
    const connectButton = document.getElementById('connect');
    const status = document.getElementById('status');

    connectButton.addEventListener('click', async () => {
      if (typeof window.ethereum === 'undefined') {
        status.textContent = 'MetaMask がインストールされていません。';
        return;
      }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();
        const address = await signer.getAddress();

        const message = "この操作を承認します";
        const signature = await signer.signMessage(message);

        status.textContent = "署名が完了しました。アプリに戻ります...";

        // ✅ 2秒間待機してからアプリに戻る
        setTimeout(() => {
          const redirectUrl = `appscheme://callback?address=${address}&signature=${encodeURIComponent(signature)}`;
          window.location.href = redirectUrl;
        }, 2000);

      } catch (err) {
        console.error("接続・署名エラー:", err);
        status.textContent = "ウォレット接続または署名に失敗しました。";
      }
    });
  </script>
</body>
</html>
