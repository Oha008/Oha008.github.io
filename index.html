<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MetaMask署名</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<h1>MetaMask署名ページ</h1>
<p id="status">MetaMaskに接続中...</p>

<script>
(async () => {
  if (typeof window.ethereum === 'undefined') {
    document.getElementById('status').innerText = 'MetaMaskが見つかりません。';
    return;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const message = urlParams.get('message') || 'ログイン確認';

  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    const signer = provider.getSigner();
    const address = await signer.getAddress();

    const signature = await signer.signMessage(message);

    // 署名後、自分のアプリに戻る
    const appDeeplink = `appscheme://callback?address=${encodeURIComponent(address)}&signature=${encodeURIComponent(signature)}`;
    window.location.href = appDeeplink;
  } catch (error) {
    console.error('署名失敗:', error);
    document.getElementById('status').innerText = '署名に失敗しました。';
  }
})();
</script>
</body>
</html>
